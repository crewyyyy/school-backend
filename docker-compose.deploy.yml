name: school

services:
  backend:
    container_name: ${CONTAINER_NAME:-school-api}
    image: ${BACKEND_IMAGE:-ghcr.io/crewyyyy/school-backend:latest}
    restart: unless-stopped
    ports:
      - "${HOST_PORT:-8000}:8000"
    environment:
      APP_PORT: ${APP_PORT:-8000}
      PUBLIC_SCHEME: ${PUBLIC_SCHEME:-http}
      PUBLIC_HOST: ${PUBLIC_HOST:-localhost}
      JWT_SECRET: ${JWT_SECRET:-change_me}
      DATABASE_URL: ${STANDALONE_DATABASE_URL:-sqlite+pysqlite:////data/school.db}
      MEDIA_DIR: ${STANDALONE_MEDIA_DIR:-/data/media}
      MEDIA_BASE_URL: ${STANDALONE_MEDIA_BASE_URL:-}
      STORAGE_BACKEND: local
      AUTO_CREATE_ADMIN: ${AUTO_CREATE_ADMIN:-true}
      BOOTSTRAP_ADMIN_LOGIN: ${BOOTSTRAP_ADMIN_LOGIN:-admin}
      BOOTSTRAP_ADMIN_PASSWORD: ${BOOTSTRAP_ADMIN_PASSWORD:-admin123}
      FCM_SERVICE_ACCOUNT_JSON: ${FCM_SERVICE_ACCOUNT_JSON:-/app/secrets/fcm-service-account.json}
      FCM_TOPIC: ${FCM_TOPIC:-school_all}
    volumes:
      - backend_data:/data
      - ./secrets:/app/secrets:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=2)\"",
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  tg-bot:
    container_name: ${TG_BOT_CONTAINER_NAME:-school-api-tg-bot}
    image: ${BACKEND_IMAGE:-ghcr.io/crewyyyy/school-backend:latest}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    environment:
      TG_BOT_TOKEN: ${TG_BOT_TOKEN:-}
      TG_ADMIN_CHAT_ID: ${TG_ADMIN_CHAT_ID:-}
      TG_BOT_ALLOWED_CHAT_IDS: ${TG_BOT_ALLOWED_CHAT_IDS:-}
      TG_BOT_API_BASE_URL: ${TG_BOT_API_BASE_URL:-http://backend:8000}
      TG_BOT_API_LOGIN: ${TG_BOT_API_LOGIN:-admin}
      TG_BOT_API_PASSWORD: ${TG_BOT_API_PASSWORD:-admin123}
      TG_BOT_DEFAULT_TITLE: ${TG_BOT_DEFAULT_TITLE:-EduFlow notification}
    command: ["python", "scripts/tg_push_bot.py"]

  watchtower:
    image: containrrr/watchtower:latest
    container_name: ${WATCHTOWER_CONTAINER_NAME:-school-api-watchtower}
    restart: unless-stopped
    profiles: ["watchtower"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval ${WATCHTOWER_INTERVAL:-60} --cleanup ${CONTAINER_NAME:-school-api}

volumes:
  backend_data:
    name: school-api-data
